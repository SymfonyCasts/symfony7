# Adding Slug and Timestamp Fields

Let's add some new fields to our `Starship` entity. The first field I'd like to add
is a `slug`. This will be a slugified version of the `name` - unique,
lowercased and without spaces or special characters, perfect to use in our URL
instead of the `id` we have now!

The other two fields are `updatedAt` and `createdAt`. `createdAt` will
be set to the current time whenever a new entity is created. `updatedAt` will be
set to the current time whenever anything in entity changes.

We can use `make:entity` to add these! Spin over to your console and run:

```terminal
symfony console make:entity Starship
```

Instead of creating a new entity, running the command with `Starship` as the argument
enables us to add new fields to this existing entity. Add the fields: `slug`, type
`string`, length `255`. "Should it be nullable?" - no, but choose `yes` for now.
`updatedAt`, `datetime_immutable`, nullable? no, but choose `yes` right now.
Same for `createdAt`.

Hit `Enter` to exit the command. Before creating the migration, let's check the
`Starship` entity to see the new fields. Open `src/Entity/Starship.php`. We can remove
`length: 255` for `$slug` as it's the default.

Now, in your terminal, create a migration with:

```terminal
symfony console make:migration
```

Remember, migrations are generated by comparing the current database and the entity to find
changes. Doctrine automatically detects the new fields and generates the correct SQL.
Back in our IDE, open the new migration. In the `up()` method, we can see it's altering
the `starship` table and adding the three columns. Add a description: "Add slug and timestamps
to starship".

In your terminal, run the migration:

```terminal
symfony console doctrine:migrations:migrate
```

Success! The new fields have been added, but they're all `null`. Take a look by running:

```terminal
symfony console doctrine:query:sql 'SELECT name, slug, updated_at, created_at FROM starship'
```

These three empty columns are blank which means they're `null`.

We need these three new fields to be not-null and the `slug` to also be unique. Because
we have existing data, we need to create a second migration that first updates these
fields based on the existing data, then updates the field definition.

Open our `Starship` entity. For the `$slug` field, remove `nullable: true` and set `unique: true`.
For `$updatedAt` and `$createdAt`, remove `nullable: true`.

In your terminal, create the second migration by running:

```terminal
symfony console make:migration
```

In your IDE, open the new migration. In the `up()` method, we can see it's altering the
three fields to make them `NOT NULL` and also creating a *unique index* on the `slug` field.
Add a description: "Make slug and timestamps not nullable".

In the terminal, run the migration:

```terminal
symfony console doctrine:migrations:migrate
```

Error! These fields can't be set to `NOT NULL` because they contain `null` values. We need to update
our second migration to ensure these fields have valid values. Open the migration again. In the
`up()` method, before the generated SQL, write
`$this->addSql('UPDATE starship SET slug = id, updated_at = arrived_at, created_at = arrived_at')`.

Let's unpack this. We're updating the starship table, setting `slug` equal to `id`. Why?
Because `id` is unique and not null - exactly what we need for the `slug`. We're also setting
`updated_at` and `created_at` equal to `arrived_at`. We know `arrived_at` is also a timestamp
and not null.

Back in the terminal, run the migration again:

```terminal
symfony console doctrine:migrations:migrate
```

It worked! Run the query again to see the data:

```terminal
symfony console doctrine:query:sql 'SELECT name, slug, updated_at, created_at FROM starship'
```

Look at that! These three new fields are now filled in with data.

When working in development like we are, it isn't a big deal to wipe our database and
start over. But... in production, you can't just clear a table to add a new required field.
This *double migration* trick can come in handy here.

We have a problem now though. Reload the fixtures:

```terminal
symfony console doctrine:fixtures:load
```

Explosion! There's nothing in our fixtures that sets these three required fields.

We could update our `StarshipFactory` to set some default values for these fields... but
I want to show a different way. There's a "doctrine extension" package that has helpers
to set these values automatically. Let's check that out next!
